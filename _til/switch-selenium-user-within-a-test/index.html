
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.3.0, mkdocs-material-8.3.9" name="generator"/>
<title>Switch selenium user within a test - rdmolony.github.io</title>
<link href="../../assets/stylesheets/main.1d29e8d0.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.cbb835fc.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="white" data-md-color-scheme="default" dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#switch-selenium-user-within-a-test">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="rdmolony.github.io" class="md-header__button md-logo" data-md-component="logo" href="../.." title="rdmolony.github.io">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            rdmolony.github.io
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Switch selenium user within a test
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="white" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="white" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"></path></svg>
</label>
</form>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="rdmolony.github.io" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="rdmolony.github.io">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    rdmolony.github.io
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
        Welcome to my blog
      </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2">
           til
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label=" til" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
           til
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../add-conda-to-the-powershell-profile/">
        Add conda to the powershell profile
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../backup-files-from-wsl-to-onedrive/">
        Backup files from wsl to onedrive
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../block-duplicate-records-being-saved-in-django/">
        Block duplicate records being saved in django
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../cache-package-manager-installs-with-buildkit/">
        Cache package manager installs with buildkit
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../cache-wget-installs-with-buildkit/">
        How to cache wget installs with buildkit
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../connect-to-mssql-db-via-sqlalchemy/">
        Connect to mssql db
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../create-a-test-mysql-database-via-pytest-django/">
        Create a test mysql database via pytest-django
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../estimate-wind-speed-forecast-uncertainty/">
        Estimate wind speed forecast uncertainty
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../flag-wind-turbine-timestamps-in-fault-time-intervals/">
        Flag wind turbine timestamps in fault time intervals
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../installing-powershell-modules-on-first-launch/">
        Installing powershell modules on first launch
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../login-to-a-django-app-via-selenium-and-pytest-django/">
        Login to a django app via selenium and pytest django
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../mock-requesting-a-file-from-an-external-website-in-pytest/">
        Mock requesting a file from an external website in pytest
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../monkeypatch-a-database-connection-in-pytest/">
        How to monkeypatch a database connection
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../restore-a-mysql-database-on-docker-compose/">
        Restore a mysql database on docker compose
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../run-django-via-docker-compose/">
        How to run django via docker compose
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../running-scripts-on-launch/">
        Running scripts on launch
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../select-all-text-between-two-strings-across-lines-via-regex/">
        Select all text between two strings across lines via regex
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../styling-powershell-with-oh-my-posh/">
        Styling Powershell with [`oh-my-posh`](https://github.com/jandedobbeleer/oh-my-posh)
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<a class="md-nav__link md-nav__link--active" href="./">
        Switch selenium user within a test
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../test-a-django-app-on-docker-via-selenium-2/">
        Test a django app on docker via selenium 2
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../test-a-django-app-on-docker-via-selenium/">
        Test a django app on docker via selenium
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../test-huey-tasks/">
        Test huey tasks
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="switch-selenium-user-within-a-test">Switch selenium user within a test<a class="headerlink" href="#switch-selenium-user-within-a-test" title="Permanent link">¶</a></h1>
<p>I want to set up and tear down a <code>Selenium</code> <code>webdriver</code> twice in the same test so that I can test how my <code>Django</code> app behaves for multiple users.  By default <code>Selenium</code> hangs if the test function <code>test_multiple_users_can_start_lists_at_different_urls</code> fails at any point beyond quitting and restarting the <code>browser</code> ...</p>
<pre><code class="language-python">import re
import socket
import time

import pytest
from pytest_django.live_server_helper import LiveServer
from selenium import webdriver
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.common.desired_capabilities import DesiredCapabilities


def _get_remote_webdriver() -&gt; webdriver.Remote:
    return webdriver.Remote(
        command_executor="http://selenium:4444/wd/hub",
        desired_capabilities=DesiredCapabilities.CHROME,
    )


@pytest.fixture
def webdriver_init() -&gt; webdriver.Remote:
    browser = _get_remote_webdriver()
    yield browser
    browser.quit()


def _get_web_container_ipaddess() -&gt; str:
    host_name = socket.gethostname()
    host_ipaddress = socket.gethostbyname(host_name)
    return host_ipaddress


@pytest.fixture
def live_server_at_web_container_ipaddress() -&gt; LiveServer:
    # Set host to externally accessible web server address
    web_container_ip_address = _get_web_container_ipaddess()
    return LiveServer(addr=web_container_ip_address)


@pytest.mark.django_db
def test_multiple_users_can_start_lists_at_different_urls(
    webdriver_init: webdriver.Remote,
    live_server_at_web_container_ipaddress: LiveServer,
) -&gt; None:
    browser = webdriver_init
    live_server_url = str(live_server_at_web_container_ipaddress)

    # Edith starts a new to-do list
    browser.get(live_server_url)
    inputbox = browser.find_element_by_id("id_new_item")
    inputbox.send_keys("Buy peacock feathers")
    inputbox.send_keys(Keys.ENTER)
    wait_for_row_in_list_table(browser, "1: Buy peacock feathers")

    # She notices that her list has a unique URL
    edith_list_url = browser.current_url
    assert re.search(
        "/lists/.+", edith_list_url
    ), f"Regex didn't match: 'lists/.+' not found in {edith_list_url}"

    # Now a new user, Francis, comes along to the site.

    ## We use a new browser session to make sure that no information
    ## of Edith's is coming through from cookies etc
    browser.quit()
    browser = _get_remote_webdriver()

    # Francis visits the home page. There is no sign of Edith's
    # list
    browser.get(live_server_url)
    page_text = browser.find_element_by_tag_name("body").text
    assert "Buy peacock feathers" not in page_text
    assert "make a fly" not in page_text

    # Francis starts a list by entering a new item. He
    # is less interesting than Edith...
    inputbox = browser.find_element_by_id("id_new_item")
    inputbox.send_keys("Buy milk")
    inputbox.send_keys(Keys.ENTER)
    wait_for_row_in_list_table(browser, "1: Buy milk")

    # Francis gets his own unique URL
    francis_list_url = browser.current_url
    assert re.search(
        "/lists/.+", francis_list_url
    ), f"Regex didn't match: 'lists/.+' not found in {francis_list_url}"
    assert francis_list_url != edith_list_url

    # Again, there is no trace of Edith's list
    page_text = browser.find_element_by_tag_name("body").text
    assert "Buy peacock feathers" not in page_text
    assert "Buy milk" in page_text

    # Satisfied, they both go back to sleep
</code></pre>
<p>I added a <code>breakpoint</code> after <code>yield</code> in <code>webdriver_init</code> ...</p>
<pre><code class="language-python-traceback">&gt; /app/functional_tests/tests.py(34)webdriver_init()
-&gt; browser.quit()
(Pdb) browser.quit()
*** selenium.common.exceptions.WebDriverException: Message: Unable to execute request for an existing session: Unable to find session with ID: 0b215f3be5545e376c41ba5d1695e6d6
Build info: version: '4.1.0', revision: '87802e897b'
System info: host: 'f9d7fe69645a', ip: '172.18.0.2', os.name: 'Linux', os.arch: 'amd64', os.version: '5.10.60.1-microsoft-standard-WSL2', java.version: '11.0.11'
Driver info: driver.version: unknown
</code></pre>
<p>... which seems to fail because the 2nd browser session is created with a different <code>session_id</code> to the 1st browser session and so <code>Selenium</code> cannot quit a browser session which is already over.  I'm hacking around this by replacing ...</p>
<pre><code class="language-python">    ...
    browser.quit()
    browser = _get_remote_webdriver()
    ...
</code></pre>
<p>... with ...</p>
<pre><code class="language-python">    ...
    browser.delete_all_cookies()
    ...
</code></pre>
<h1 id="pytest">pytest<a class="headerlink" href="#pytest" title="Permanent link">¶</a></h1>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: Styling Powershell with [`oh-my-posh`](https://github.com/jandedobbeleer/oh-my-posh)" class="md-footer__link md-footer__link--prev" href="../styling-powershell-with-oh-my-posh/" rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</div>
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Previous
              </span>
              Styling Powershell with [`oh-my-posh`](https://github.com/jandedobbeleer/oh-my-posh)
            </div>
</div>
</a>
<a aria-label="Next: Test a django app on docker via selenium 2" class="md-footer__link md-footer__link--next" href="../test-a-django-app-on-docker-via-selenium-2/" rel="next">
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Next
              </span>
              Test a django app on docker via selenium 2
            </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
<script src="../../assets/javascripts/bundle.6c7ad80a.min.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</body>
</html>